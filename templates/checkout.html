{% extends 'partials/base.html' %}
{% load static %}


{% block content %}
<div class="border-b border-gray-200 py-[2rem] flex items-center justify-between px-[19rem]">
    <h1 class="font-medium text-3xl">Checkout</h1>
    <div class="text-sm">
        <a href="{% url 'index' %}" class="hover:text-blue-400">Home /</a>
        <a href="{% url 'index' %}" class="text-[#2563eb]">Cart</a>
    </div>
</div>
<section class="bg-[#F3F4F6] py-14 px-[19rem]">



    <div class="mt-10 grid gap-8 lg:grid-cols-2">
        <div class="bg-white p-6 rounded-lg shadow-md h-fit">
            <h3 class="text-lg font-bold text-gray-800">Customer Information</h3>
            <hr class="my-4 border-gray-200">

            <form action="#" method="POST" class="space-y-4">

                <div>
                    <label for="fullName" class="block text-sm font-medium text-gray-700">Full Name</label>
                    <input type="text" id="fullName" name="fullName" required value="{{order.fullname}}"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>

                <div>
                    <label for="mobile" class="block text-sm font-medium text-gray-700">Mobile</label>
                    <input type="tel" id="mobile" name="mobile" required value="{{order.mobile}}"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>

                <div>
                    <label for="address" class="block text-sm font-medium text-gray-700">Address</label>
                    <input type="text" id="address" name="address" required value="{{order.address}}"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="city" class="block text-sm font-medium text-gray-700">City</label>
                        <input type="text" id="city" name="city" required value="{{order.city}}"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="state" class="block text-sm font-medium text-gray-700">State</label>
                        <input type="text" id="state" name="state" required value="{{order.state}}"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                </div>

            </form>
        </div>

        <div>
            <div class="overflow-hidden rounded-2xl bg-white shadow-sm ring-1 ring-slate-200 h-fit pb-7">
                <div class="border-b border-slate-200 px-6 py-5 ">
                    <h3 class="text-lg font-semibold text-slate-900 ">Order Summary</h3>
                </div>

                <div class="px-6 ">
                    <div>
                        <div class="flex items-center justify-between py-6 border-b border-slate-200 font-semibold">
                            <p>Product</p>
                            <p>SubTotal</p>
                        </div>
                        
                        {% for i in items %}
                            <div class="flex justify-between items-center py-6 border-b border-slate-200">
                                <p>{{i.product.name}}</p>
                                <p>{{i.sub_total}}</p>
                            </div>
                        {% endfor %}
                            
                        

                        <div class="flex items-center justify-between py-6">
                            <span class="text-base font-semibold text-slate-900">Total</span>
                            <span class="text-lg font-semibold text-slate-900">${{order.total}}</span>
                        </div>
                    </div>




                </div>

            </div>

            <div class="flex justify-end w-full">
                <button id="payButton" type="button"
                    class="mt-2 px-8 py-3 rounded-lg bg-green-500 font-semibold text-white hover:bg-green-700 mt-3">
                    Pay
                </button>
                </di>
            </div>



        </div>
    </div>


</section>

<script src="https://js.paystack.co/v1/inline.js"></script>

<script>
    const payButton = document.getElementById('payButton');

    payButton.addEventListener('click', function (e) {
        e.preventDefault();

        const email = "{{request.user.email}}";
        const amountNaira = "{{order.total}}";
        const amountKobo = amountNaira * 100;

        const handler = PaystackPop.setup({
            key: "pk_test_6ed2e7ba52d3479ce96162a2f0b6083a88a95817",
            email: email,
            amount: amountKobo,
            currency: "NGN",
            ref: "REF_" + String(new Date().getTime()),

            callback: function (response) {
                Swal.fire({
                    title: 'Verifying Payment...',
                    text: 'Please wait while we confirm your transaction.',
                    allowOutsideClick: false,
                    didOpen: () => { Swal.showLoading(); }
                });

                fetch("/api/paystack/verify/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCookie("csrftoken"),
                    },
                    body: JSON.stringify({
                        reference: response.reference,
                        status: response.status
                    }),
                })
                    .then(res => {
                        if (!res.ok) {
                            return res.json().then(err => { throw err; });
                        }
                        return res.json();
                    })
                    .then(data => {
                        if (data.status === "success") {
                            Swal.fire({
                                icon: 'success',
                                title: 'Success!',
                                text: 'Your payment has been verified.',
                            }).then(() => {
                                window.location.href = "/checkout/payment/status/" + "{{order.id}}";
                            });
                        } else {
                            Swal.fire({ icon: 'error', title: 'Failed', text: data.message });
                        }
                    })
                    .catch(err => {
                        console.error("Verification Error:", err);
                        Swal.fire({ icon: 'error', title: 'Error', text: err.message || 'Verification failed.' });
                    });
            }
        });

        handler.openIframe();
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>



{% endblock content %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Product | {{ product.name }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                    },
                    colors: {
                        indigo: { 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca' }
                    }
                }
            }
        }
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap">

    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        html {
            scroll-behavior: smooth;
        }

        /* Independent scrolling for main content */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        @media (max-width: 768px) {
            .mobile-padding {
                padding: 1.5rem !important;
            }

            .mobile-header {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 1rem !important;
            }
        }
    </style>
</head>

<body class="bg-[#F8F9FC] h-screen flex overflow-hidden">

    <aside class="w-64 bg-white border-r border-slate-200 hidden lg:block flex-shrink-0 z-20">
        {% include 'vendor/includes/vendor.sidebar.html' %}
    </aside>

    <div id="drawer-navigation"
        class="fixed top-0 left-0 z-40 h-screen p-2 transition-transform -translate-x-full bg-white w-fit"
        tabindex="-1">
        <button type="button" data-drawer-hide="drawer-navigation"
            class="text-gray-400 bg-transparent hover:bg-gray-200 rounded-lg text-sm p-1.5 absolute top-2.5 end-2.5"><i
                class="fa-solid fa-xmark"></i></button>
        <div>{% include 'vendor/includes/vendor.sidebar.html' %}</div>
    </div>

    <main class="flex-1 px-4 lg:px-[6%] 2xl:px-[10%] p-8 overflow-y-auto h-full mobile-padding">

        {% if messages %}
        {% for message in messages %}
        <script>
            Swal.fire({
                icon: "{% if message.tags == 'error' %}error{% else %}success{% endif %}",
                title: "{{ message }}",
                confirmButtonColor: '#4f46e5',
            });
        </script>
        {% endfor %}
        {% endif %}

        <form action="" method="POST" id="product-form" enctype="multipart/form-data">
            {% csrf_token %}

            <header class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-10 mobile-header">
                <div>
                    <div
                        class="flex items-center gap-2 text-[11px] font-bold uppercase tracking-widest text-slate-400 mb-2">
                        <a href="{% url 'vendor_product_list' %}"
                            class="hover:text-indigo-600 transition-colors">Products</a>
                        <i class="fa-solid fa-chevron-right text-[8px]"></i>
                        <span class="text-slate-900">Edit Product</span>
                    </div>
                    <h1 class="font-black text-3xl text-slate-900 tracking-tight">Edit "{{ product.name }}"</h1>
                </div>

                <div class="flex items-center gap-3">
                    <button type="button"
                        class="lg:hidden p-3 text-slate-600 bg-white border border-slate-200 rounded-xl"
                        data-drawer-target="drawer-navigation" data-drawer-show="drawer-navigation">
                        <i class="fa-solid fa-bars-staggered"></i>
                    </button>
                    <a href="{% url 'vendor_product_list' %}"
                        class="px-6 py-3 bg-white border border-slate-200 text-slate-700 rounded-2xl text-sm font-bold hover:bg-slate-50 transition-all">Discard</a>
                    <button type="submit"
                        class="flex items-center gap-2 bg-indigo-600 text-white px-8 py-3 rounded-2xl text-sm font-bold hover:bg-indigo-700 transition-all shadow-xl shadow-indigo-200">
                        <i class="fa-solid fa-check-double"></i> Save Changes
                    </button>
                </div>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 pb-20">
                <div class="lg:col-span-2 space-y-8">

                    <section class="bg-white border border-slate-100 rounded-[2.5rem] p-8 shadow-sm">
                        <h2 class="text-lg font-black text-slate-900 mb-6 flex items-center gap-3">
                            <span
                                class="h-8 w-8 rounded-lg bg-indigo-50 text-indigo-600 flex items-center justify-center text-sm"><i
                                    class="fa-regular fa-file-lines"></i></span>
                            Content Details
                        </h2>
                        <div class="space-y-6">
                            <div>
                                <label
                                    class="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2 ml-1">Product
                                    Title</label>
                                <input type="text" name="name" value="{{ product.name }}" required
                                    class="w-full rounded-2xl border-slate-100 bg-slate-50/50 p-4 text-slate-900 font-semibold focus:ring-indigo-500 focus:border-indigo-500 transition-all">
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2 ml-1">Short
                                    Description</label>
                                <textarea name="description" rows="5" required
                                    class="w-full rounded-2xl border-slate-100 bg-slate-50/50 p-4 text-slate-600 focus:ring-indigo-500 focus:border-indigo-500 resize-none transition-all">{{ product.description }}</textarea>
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2 ml-1">Specifications
                                    / Additional Info</label>
                                <textarea name="additional_info" rows="3"
                                    class="w-full rounded-2xl border-slate-100 bg-slate-50/50 p-4 text-slate-600 focus:ring-indigo-500 focus:border-indigo-500 resize-none transition-all">{{ product.additional_information }}</textarea>
                            </div>
                        </div>
                    </section>

                    <section class="bg-white border border-slate-100 rounded-[2.5rem] p-8 shadow-sm">
                        <h2 class="text-lg font-black text-slate-900 mb-6 flex items-center gap-3">
                            <span
                                class="h-8 w-8 rounded-lg bg-emerald-50 text-emerald-600 flex items-center justify-center text-sm"><i
                                    class="fa-solid fa-calculator"></i></span>
                            Inventory & Pricing
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label
                                    class="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2 ml-1">Regular
                                    Price ($)</label>
                                <input type="number" name="regular_price" step="0.01"
                                    value="{{ product.regular_price }}" required
                                    class="w-full rounded-2xl border-slate-100 bg-slate-50/50 p-4 font-bold text-slate-900">
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2 ml-1">Sale
                                    Price ($)</label>
                                <input type="number" name="sale_price" step="0.01" value="{{ product.sale_price }}"
                                    required
                                    class="w-full rounded-2xl border-slate-100 bg-slate-50/50 p-4 font-bold text-indigo-600">
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2 ml-1">Stock
                                    Count</label>
                                <input type="number" name="qty" value="{{ product.qty }}" required
                                    class="w-full rounded-2xl border-slate-100 bg-slate-50/50 p-4 font-bold text-slate-900">
                            </div>
                        </div>
                    </section>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white border border-slate-100 rounded-[2.5rem] p-6 relative">
                            <h2 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4 ml-1">Product
                                Image</h2>
                            <div id="image-preview-container" class="relative group h-52">
                                <label id="label-image"
                                    class="flex flex-col items-center justify-center w-full h-full border-2 border-slate-100 border-dashed rounded-[2rem] cursor-pointer bg-slate-50/50 hover:bg-indigo-50/50 transition-all overflow-hidden">
                                    <div
                                        class="preview-placeholder {% if product.image %}hidden{% endif %} flex flex-col items-center">
                                        <i class="fa-solid fa-upload text-indigo-600 mb-2"></i>
                                        <p class="text-[10px] font-bold text-slate-400">Replace Image</p>
                                    </div>
                                    {% if product.image %}
                                    <img src="{{ product.image.url }}"
                                        class="w-full h-full object-contain rounded-[1.8rem]">
                                    {% endif %}
                                    <input type="file" name="image" id="input-image" class="hidden" accept="image/*" />
                                </label>
                                <button type="button" onclick="removeImage('image')"
                                    class="{% if not product.image %}hidden{% endif %} absolute top-3 right-3 bg-red-500 text-white rounded-full h-8 w-8 flex items-center justify-center shadow-lg transition-transform hover:scale-110 z-10"><i
                                        class="fa-solid fa-xmark"></i></button>
                            </div>
                        </div>

                        <div class="bg-white border border-slate-100 rounded-[2.5rem] p-6 relative">
                            <h2 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4 ml-1">
                                Cover Image</h2>
                            <div id="cover_image-preview-container" class="relative group h-52">
                                <label id="label-cover_image"
                                    class="flex flex-col items-center justify-center w-full h-full border-2 border-slate-100 border-dashed rounded-[2rem] cursor-pointer bg-slate-50/50 hover:bg-indigo-50/50 transition-all overflow-hidden">
                                    <div
                                        class="preview-placeholder {% if product.cover_image %}hidden{% endif %} flex flex-col items-center">
                                        <i class="fa-solid fa-upload text-indigo-600 mb-2"></i>
                                        <p class="text-[10px] font-bold text-slate-400">Replace Banner</p>
                                    </div>
                                    {% if product.cover_image %}
                                    <img src="{{ product.cover_image.url }}"
                                        class="w-full h-full object-contain rounded-[1.8rem]">
                                    {% endif %}
                                    <input type="file" name="cover_image" id="input-cover_image" class="hidden"
                                        accept="image/*" />
                                </label>
                                <button type="button" onclick="removeImage('cover_image')"
                                    class="{% if not product.cover_image %}hidden{% endif %} absolute top-3 right-3 bg-red-500 text-white rounded-full h-8 w-8 flex items-center justify-center shadow-lg transition-transform hover:scale-110 z-10"><i
                                        class="fa-solid fa-xmark"></i></button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-8">
                    <section class="bg-white border border-slate-100 rounded-[2.5rem] p-8 shadow-sm">
                        <h2 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-6 ml-1">Organization
                        </h2>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-[11px] font-bold text-slate-700 mb-2">Current Status</label>
                                <select name="status"
                                    class="w-full rounded-2xl border-slate-100 bg-slate-50/50 p-4 text-sm font-bold appearance-none">
                                    {% for s in status %}
                                    <option value="{{ s.0 }}" {% if product.status == s.0 %}selected{% endif %}>{{ s.1 }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label class="block text-[11px] font-bold text-slate-700 mb-2">Collection /
                                    Category</label>
                                <select name="category"
                                    class="w-full rounded-2xl border-slate-100 bg-slate-50/50 p-4 text-sm font-bold appearance-none">
                                    {% for c in categories %}
                                    <option value="{{ c.id }}" {% if product.category.id == c.id %}selected{% endif %}>{{c.title }}</option>
                                        
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </section>

                    <section class="bg-white border border-slate-100 rounded-[2.5rem] p-8 shadow-sm">
                        <h2 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-6 ml-1">Settings</h2>
                            
                        <div class="space-y-5">
                            <div class="flex items-center justify-between group">
                                <span class="text-sm font-bold text-slate-700">In Stock</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="in_stock" class="sr-only peer" {% if product.in_stock %}checked{% endif %}>
                                        
                                    <div
                                        class="w-11 h-6 bg-slate-100 rounded-full peer peer-checked:bg-indigo-600 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full shadow-inner">
                                    </div>
                                </label>
                            </div>
                           
                            <div class="flex items-center justify-between group">
                                <span class="text-sm font-bold text-slate-700">Free Delivery</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="free_delivery" class="sr-only peer" {% if product.free_delivery %}checked{% endif %}>
                                        
                                    <div
                                        class="w-11 h-6 bg-slate-100 rounded-full peer peer-checked:bg-indigo-600 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full shadow-inner">
                                    </div>
                                </label>
                            </div>
                            <div class="flex items-center justify-between group">
                                <span class="text-sm font-bold text-slate-700">New Arrivals</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="new_arrivals" class="sr-only peer" {% if product.new_arrivals %}checked{% endif %}>
                                        
                                    <div
                                        class="w-11 h-6 bg-slate-100 rounded-full peer peer-checked:bg-indigo-600 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full shadow-inner">
                                    </div>
                                </label>
                            </div>
                           
                        </div>
                    </section>
                </div>
            </div>
        </form>
    </main>

    <script>
        // Image Preview & Removal Logic
        function setupImagePreview(inputName) {
            const input = document.getElementById(`input-${inputName}`);
            const label = document.getElementById(`label-${inputName}`);
            const container = document.getElementById(`${inputName}-preview-container`);
            const removeBtn = container.querySelector('button');

            input.addEventListener('change', function () {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        let img = label.querySelector('img');
                        if (!img) {
                            img = document.createElement('img');
                            img.className = "w-full h-full object-cover rounded-[1.8rem]";
                            label.appendChild(img);
                        }
                        img.src = e.target.result;
                        label.querySelector('.preview-placeholder').classList.add('hidden');
                        removeBtn.classList.remove('hidden');
                    }
                    reader.readAsDataURL(file);
                }
            });
        }

        function removeImage(inputName) {
            const input = document.getElementById(`input-${inputName}`);
            const label = document.getElementById(`label-${inputName}`);
            const container = document.getElementById(`${inputName}-preview-container`);
            const removeBtn = container.querySelector('button');
            const img = label.querySelector('img');

            input.value = "";
            if (img) img.remove();
            label.querySelector('.preview-placeholder').classList.remove('hidden');
            removeBtn.classList.add('hidden');
        }

        setupImagePreview('image');
        setupImagePreview('cover_image');

        // Real-time Duplicate Check
        const nameInput = document.querySelector('input[name="name"]');
        let typingTimer;

        nameInput.addEventListener('input', function () {
            clearTimeout(typingTimer);
            const originalName = "{{ product.name }}";
            const productName = nameInput.value.trim();

            if (productName && productName !== originalName) {
                typingTimer = setTimeout(() => {
                    fetch(`/vendor/ajax/check-product-name/?name=${encodeURIComponent(productName)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.exists) {
                                Swal.fire({
                                    icon: 'warning',
                                    title: 'Duplicate Name',
                                    text: 'Another product already uses this title.',
                                    confirmButtonColor: '#4f46e5',
                                });
                                nameInput.classList.add('border-red-500', 'ring-red-500');
                            } else {
                                nameInput.classList.remove('border-red-500', 'ring-red-500');
                            }
                        });
                }, 500);
            }
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.js"></script>
</body>

</html>
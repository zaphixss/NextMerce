{% extends 'partials/base.html' %}
{% load static %}


{% block content %}
<div class="border-b border-gray-200 py-[2rem] flex items-center justify-between px-[19rem]">
    <h1 class="font-medium text-3xl">Cart</h1>
    <div class="text-sm">
        <a href="{% url 'index' %}" class="hover:text-blue-400">Home /</a>
        <a href="{% url 'index' %}" class="text-[#2563eb]">Cart</a>
    </div>
</div>
<section class="bg-[#F3F4F6] py-14 px-[19rem]">

    <div class="flex items-center justify-between">
        <h2 class="text-2xl font-semibold text-slate-900">Your Cart</h2>
        <a href="#" class="text-sm font-medium text-blue-600 hover:text-blue-700">
            Clear Shopping Cart
        </a>
    </div>

    <!-- Cart table card -->
    <div class="mt-8 overflow-hidden rounded-2xl bg-white shadow-sm ring-1 ring-slate-200">

        <!-- Head -->
        <div class="grid grid-cols-12 gap-4 border-b border-slate-200 px-6 py-5 text-sm font-semibold text-slate-900">
            <div class="col-span-5">Product</div>
            <div class="col-span-2">Price</div>
            <div class="col-span-3 text-center">Quantity</div>
            <div class="col-span-1 text-right">Subtotal</div>
            <div class="col-span-1 text-right">Action</div>
        </div>

        <!-- Rows -->
        {% for c in cart %}
        <div class="grid grid-cols-12 items-center gap-4 px-6 py-6">
            <!-- Product -->
            <div class="col-span-5 flex items-center gap-5 min-w-0">
                <div class="h-16 w-16 overflow-hidden rounded-2xl bg-slate-100 ring-1 ring-slate-200 shrink-0">
                    <img src="{{ c.product.image.url }}" alt="{{ c.product.name }}"
                        class="h-full w-full object-cover" />
                </div>

                <div class="min-w-0">
                    <p class="truncate text-[15px] font-semibold text-slate-900">{{ c.product.name }}</p>
                </div>
            </div>

            <!-- Price -->
            <div class="col-span-2 text-slate-700 font-medium">
                ${{ c.product.sale_price }}
            </div>

            <!-- Quantity column -->
            <!-- <div class="col-span-3 flex justify-center">
                    <div class="qty-picker flex items-center overflow-hidden rounded-full border border-slate-200 bg-white"
                        data-stock="{{ c.product.qty }}" data-qty="{{ c.quantity|default:1 }}"
                        data-unit-price="{{ c.product.sale_price }}">
                        <button type="button" data-action="dec"
                            class="grid h-11 w-11 place-items-center text-slate-700 hover:bg-slate-50 disabled:opacity-40">
                            <i class="fa-solid fa-minus text-sm"></i>
                        </button>

                        <div data-qty-display
                            class="grid h-11 w-14 place-items-center border-x border-slate-200 text-sm font-semibold text-slate-900">
                            {{ c.quantity|default:1 }}
                        </div>

                        <button type="button" data-action="inc"
                            class="grid h-11 w-11 place-items-center text-slate-700 hover:bg-slate-50 disabled:opacity-40">
                            <i class="fa-solid fa-plus text-sm"></i>
                        </button>

                        <input type="hidden" name="qty" value="{{ c.quantity|default:1 }}" data-qty-input />
                    </div>
                </div> -->

            <form class="col-span-3 flex justify-center" method="POST" action="{% url 'cart_update' c.id %}">
                {% csrf_token %}
                <input type="number" name="qty" value="{{c.qty}}" class="w-24 rounded-full border border-slate-300 bg-white px-4 py-2 text-sm text-slate-900
                   shadow-sm outline-none focus:border-indigo-600 focus:ring-2 focus:ring-indigo-500/60">
                <button class="p-2 bg-indigo-600 text-white"><i class="fas fa-check-circle"></i></button>
            </form>




            <!-- Subtotal column -->
            <div class="col-span-1 text-right font-semibold text-slate-900" data-subtotal>
                ${{ c.sub_total }}
            </div>

            <!-- Action (right aligned) -->
            <div class="col-span-1 flex justify-end">
                <a href="{% url 'cart_delete' c.id %}"
                    class="grid h-11 w-11 place-items-center rounded-full border border-slate-200 text-slate-700 hover:bg-slate-100"
                    aria-label="Remove">
                    <i class="fa-regular fa-trash-can"></i>
                </a>
            </div>
        </div>

        {% if not forloop.last %}
        <div class="mx-6 h-px bg-slate-200"></div>
        {% endif %}
        {% endfor %}
    </div>


    <!-- Bottom grid -->
    <div class="mt-10 grid gap-8 lg:grid-cols-2">


        <div class="overflow-hidden rounded-2xl bg-white shadow-sm ring-1 ring-slate-200">
            <div class="border-b border-slate-200 px-6 py-5">
                <h3 class="text-lg font-semibold text-slate-900">Order Summary</h3>
            </div>

            <div class="px-6 py-6">

                <!-- total -->
                <div class="flex items-center justify-between py-6">
                    <span class="text-base font-semibold text-slate-900">Total</span>
                    <span class="text-lg font-semibold text-slate-900">${{total}}</span>
                </div>

                <button type="button"
                    class="mt-2 h-12 w-full rounded-full bg-indigo-600 text-sm font-semibold text-white hover:bg-indigo-700">
                    Process to Checkout
                </button>

                <button id="payButton" class="px-4 py-2 bg-green-600 text-white rounded">
                    Pay Now
                </button>


            </div>
        </div>
    </div>



</section>

<script src="https://js.paystack.co/v1/inline.js"></script>

<script>
    const payButton = document.getElementById('payButton');

    payButton.addEventListener('click', function (e) {
        e.preventDefault();

        // Replace with your own values (probably fetched from backend / DOM)
        const email = "{{request.user.email}}";
        const amountNaira = "{{total}}";

        // amount must be in kobo on Paystack (x100)
        const amountKobo = amountNaira * 100;

        const handler = PaystackPop.setup({
            key: "pk_test_6ed2e7ba52d3479ce96162a2f0b6083a88a95817", // YOUR PUBLIC KEY
            email: email,
            amount: amountKobo,
            currency: "NGN",
            ref: "REF_" + String(new Date().getTime()), // unique ref from your backend in real app

            // Called when payment is complete on Paystack's side (but not yet verified by you)
            callback: function (response) {
                // response.reference is your unique ref
                console.log("Payment complete! Reference:", response.reference);

                // // Send reference to your backend for verification
                // fetch("/api/paystack/verify/", {
                //     method: "POST",
                //     headers: {
                //         "Content-Type": "application/json",
                //         "X-CSRFToken": getCookie("csrftoken"), // if using Django
                //     },
                //     body: JSON.stringify({ reference: response.reference }),
                // })
                //     .then(res => res.json())
                //     .then(data => {
                //         if (data.status === "success") {
                //             alert("Payment verified and successful ✅");
                //         } else {
                //             alert("Payment could not be verified ❌");
                //         }
                //     })
                //     .catch(err => {
                //         console.error(err);
                //         alert("Error verifying payment");
                //     });
            },

            onClose: function () {
                console.log("Payment popup closed");
            }
        });

        handler.openIframe();
    });

    // Helper: get CSRF (for Django)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>



{% endblock content %}